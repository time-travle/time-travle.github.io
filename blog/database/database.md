# 数据库相关 知识

<p>
<a href="#" onclick="refreshDatabaseContent('mysql')">Mysql 相关</a>&emsp;&emsp;&emsp;
<a href="#" onclick="refreshDatabaseContent('oracle')">Oracle 相关</a>&emsp;&emsp;&emsp;
<a href="#" onclick="refreshDatabaseContent('question')">问题相关</a>&emsp;&emsp;&emsp;
<a href="#" onclick="refreshDatabaseContent('pool')">连接池相关</a>&emsp;&emsp;&emsp;
</p>

---

## 优化

### SQL 优化

    1、查询时 可以尽量是用大写的
    2、合理使用索引  不要过分使用索引  索引可以提高查找效率 当时增加了插入和更新的效率
    3、不全查字段 要尽量避免全表扫描
    4、使用预编译
    5、是用存储过程、视图
    6、合理使用 where 过滤条件 
        应尽量避免在 where 子句中对字段进行 null 值判断，尽量避免在 where 子句中使用 != 或 <> 操作符，
        否则将导致引擎放弃使用索引而进行全表扫描
        应尽量避免在 where 子句中使用 or 来连接条件，如果一个字段有索引，一个字段没有索引，将导致引擎放弃使用索引而进行全表扫描
        in 和 not in 也要慎用，否则会导致全表扫描 ，很多时候用 exists 代替 in 是一个好的选择 ，对于连续的数值，能用 between 就不要用 in
    7、减少使用聚合函数 去重函数和排序函数等增加查询时间的函数 
        .应尽量避免在where子句中对字段进行函数操作
    https://blog.csdn.net/qq_15901351/article/details/90741593

#### 优化方式：

    1、查询出的数据量过大（可以采用多次查询，其他的方法降低数据量），尽量采取分页查询数据
    2、锁或者死锁(这也是查询慢常见的问题，是程序设计的缺陷)
    3、返回了不必要的行和列
        用OR的字句可以分解成多个查询，并且通过UNION链接多个查询。它们的速度只与是否使用索引有关，如果查询需要用到联合索引，用UNION all执行的效率更高。
    4、如果是使用like进行查询的话，简单的使用index是不行的，但是全文索引，耗空间。 like 'a%' 使用索引 like '%a' 不使用索引用 like '%a%' 查询时，查询耗时和字段值总长度成正比,所以不能用CHAR类型，而是VARCHAR。对于字段的值很长的建全文索引。
    5、尽量将数据的处理工作放在服务器上，减少网络的开销，如使用存储过程。存储过程是编译、优化过，并且被组织到一个执行规划里，且存储在数据库中的SQL语句（存储过程是数据库服务器端的一段程序），是控制流语言的集合，速度当然快。
    6、将需要查询的结果预先计算好放在表中，查询的时候再Select。这在SQL7.0以前是最重要的手段。例如计算商品购买小计计算。
    7、没有必要时不要用DISTINCT和ORDER BY，这些动作可以改在客户端执行。它们增加了额外的开销。这同UNION和UNION ALL一样的道理。
    8、一次更新多条记录比分多次更新每次一条快,就是说批处理好
    9、用临时表，尽量用结果集和Table类性的变量来代替它,Table 类型的变量比临时表好
    10、数据库设计：数据库内所有表结构均添加索引

## 优化一览图：

![avatar](../blog/database/imgs/img.png)

### 1 软优化

#### 1.1 查询语句优化

1、首先我们可以用EXPLAIN或DESCRIBE(简写:DESC)命令分析一条查询语句的执行信息.

#### 1.2 优化子查询

在MySQL中,尽量使用JOIN来代替子查询.因为子查询需要嵌套查询,嵌套查询时会建立一张临时表,临时表的建立和删除都会有较大的系统开销,而连接查询不会创建临时表,因此效率比嵌套子查询高.

#### 1.3 使用索引

索引是提高数据库查询速度最重要的方法之一,关于索引可以参高笔者一文,介绍比较详细,此处记录使用索引的三大注意事项:

    1、LIKE关键字匹配'%'开头的字符串,不会使用索引
    
    2、OR关键字的两个字段必须都是用了索引,该查询才会使用索引.
    
    3、使用多列索引必须满足最左匹配.

#### 1.4 分解表

对于字段较多的表,如果某些字段使用频率较低,此时应当,将其分离出来从而形成新的表,

#### 1.5 中间表

对于将大量连接查询的表可以创建中间表,从而减少在查询时造成的连接耗时.

#### 1.6 增加冗余字段

类似于创建中间表,增加冗余也是为了减少连接查询.

#### 1.7 分析表,检查表,优化表

分析表主要是分析表中关键字的分布,检查表主要是检查表中是否存在错误,优化表主要是消除删除或更新造成的表空间浪费.

    1、分析表: 使用 ANALYZE 关键字,如ANALYZE TABLE user;
        Op:表示执行的操作.
        Msg_type:信息类型,有status,info,note,warning,error.
        Msg_text:显示信息.

    2、检查表: 使用 CHECK关键字,如CHECK TABLE user [option]
        option 只对MyISAM有效,共五个参数值:
            
            QUICK:不扫描行,不检查错误的连接.
            FAST:只检查没有正确关闭的表.
            CHANGED:只检查上次检查后被更改的表和没被正确关闭的表.
            MEDIUM:扫描行,以验证被删除的连接是有效的,也可以计算各行关键字校验和.
            EXTENDED:最全面的的检查,对每行关键字全面查找.    

    3、优化表:使用OPTIMIZE关键字,如OPTIMIZE [LOCAL|NO_WRITE_TO_BINLOG] TABLE user;
    LOCAL|NO_WRITE_TO_BINLOG都是表示不写入日志.,优化表只对VARCHAR,BLOB和TEXT有效,通过OPTIMIZE TABLE语句可以消除文件碎片,在执行过程中会加上只读锁.


###2 硬优化

####2.1 硬件三件套
    1、配置多核心和频率高的cpu,多核心可以执行多个线程.
        
    2、配置大内存,提高内存,即可提高缓存区容量,因此能减少磁盘I/O时间,从而提高响应速度.
        
    3、配置高速磁盘或合理分布磁盘:高速磁盘提高I/O,分布磁盘能提高并行操作的能力.
    

####2.2 优化数据库参数
优化数据库参数可以提高资源利用率,从而提高MySQL服务器性能.MySQL服务的配置参数都在my.cnf或my.ini,下面列出性能影响较大的几个参数.
    
    key_buffer_size:索引缓冲区大小
    table_cache:能同时打开表的个数
    query_cache_size和query_cache_type:前者是查询缓冲区大小,后者是前面参数的开关,0表示不使用缓冲区,1表示使用缓冲区,但可以在查询中使用SQL_NO_CACHE表示不要使用缓冲区,2表示在查询中明确指出使用缓冲区才用缓冲区,即SQL_CACHE.
    sort_buffer_size:排序缓冲区

####2.3 分库分表
    因为数据库压力过大，首先一个问题就是高峰期系统性能可能会降低，因为数据库负载过高对性能会有影响。
        另外一个，压力过大把你的数据库给搞挂了怎么办？所以此时你必须得对系统做分库分表 + 读写分离，也就是把一个库拆分为多个库，
    部署在多个数据库服务上，这时作为主库承载写入请求。然后每个主库都挂载至少一个从库，由从库来承载读请求。

####2.4 缓存集群
    如果用户量越来越大，此时你可以不停的加机器，比如说系统层面不停加机器，就可以承载更高的并发请求。
    然后数据库层面如果写入并发越来越高，就扩容加数据库服务器，通过分库分表是可以支持扩容机器的，
    
    如果数据库层面的读并发越来越高，就扩容加更多的从库。
    但是这里有一个很大的问题：数据库其实本身不是用来承载高并发请求的，所以通常来说，数据库单机每秒承载的并发就在几千的数量级，而且数据库使用的机器都是比较高配置，比较昂贵的机器，成本很高。
    
    如果你就是简单的不停的加机器，其实是不对的。
    所以在高并发架构里通常都有缓存这个环节，缓存系统的设计就是为了承载高并发而生。
    所以单机承载的并发量都在每秒几万，甚至每秒数十万，对高并发的承载能力比数据库系统要高出一到两个数量级。
    
    所以你完全可以根据系统的业务特性，对那种写少读多的请求，引入缓存集群。
    具体来说，就是在写数据库的时候同时写一份数据到缓存集群里，然后用缓存集群来承载大部分的读请求。
    这样的话，通过缓存集群，就可以用更少的机器资源承载更高的并发。

##MySQL数据库优化方法汇总

###数据库结构优化
    1）范式优化：表的设计合理化（符合3NF），比如消除冗余（节省空间）；
    2）反范式优化：比如适当加冗余等（减少join）
    3）拆分表：分区将数据在物理上分隔开，不同分区的数据可以制定保存在处于不同磁盘上的数据文件里。
    
    这样，当对这个表进行查询时，只需要在表分区中进行扫描，而不必进行全表扫描，明显缩短了查询时间，
    另外处于不同磁盘的分区也将对这个表的数据传输分散在不同的磁盘I/O，一个精心设置的分区可以将数据传输对磁盘I/O竞争均匀地分散开。
    对数据量大的时时表可采取此方法，可按月自动建表分区。
###优化SQL语句
    1）应尽量避免在 where 子句中使用!=或<>操作符，否则将引擎放弃使用索引而进行全表扫描；
    2）应尽量避免在 where 子句中对字段进行 null 值判断，否则将导致引擎放弃使用索引而进行全表扫描，如：
        select id from t where num is null
    可以在num上设置默认值0，确保表中num列没有null值，然后这样查询：
        select id from t where num=0
    3）很多时候用exists代替in是一个好的选择；
    4）用Where子句替换HAVING子句，因为HAVING只会在检索出所有记录之后才对结果集进行过滤；
    5）迅速的定位执行速度慢的语句、开启慢查询、设置慢查询时间、启用慢查询日志、通过mysqldumoslow工具对慢日志进行分类汇总；
    6）析SQL语句，通过explain分析查询、通profiling可以得到更详细的信息；
    7）创建索引（主键索引/唯一索引/全文索引/普通索引）；
    8）避免Select * （不查询多余的列与行）；
    9）使用视图（经常被查询的列数据，并且这些数据不被经常的修改，删除）；

###分表技术（水平分割、垂直分割）、分区技术
如果遇到大表的情况下，SQL语句优化已经无法继续优化了，我们可以考虑分表和分区，目的就是减少数据库的负担，提高数据库的效率，通常点来讲就是提高表的增删改查效率。

分表是将一个大表按照一定的规则分解成多张具有独立存储空间的实体表，我们可以称为子表，每个表都对应三个文件，MYD数据文件，.MYI索引文件，.frm表结构文件。
这些子表可以分布在同一块磁盘上，也可以在不同的机器上。app读写的时候根据事先定义好的规则得到对应的子表名，然后去操作它。

分区和分表相似，都是按照规则分解表。不同在于分表将大表分解为若干个独立的实体表，而分区是将数据分段划分在多个位置存放，可以是同一块磁盘也可以在不同的机器。
分区后，表面上还是一张表，但数据散列到多个位置了。app读写的时候操作的还是大表名字，db自动去组织分区的数据。

    1）都能提高mysql的性能，在高并发状态下都有一个良好的表现；
    2）分表和分区不矛盾，可以相互配合的，对于那些大访问量，并且表数据比较多的表，我们可以采取分表和分区结合的方式，访问量不大，但是表数据很多的表，我们可以采取分区的方式等；
    3）分表技术是比较麻烦的，需要手动去创建子表，app服务端读写时候需要计算子表名。采用merge好一些，但也要创建子表和配置子表间的union关系；
    4）表分区相对于分表，操作方便，不需要创建子表。

###读写分离
MySQL读写分离可以参考：阿里云MySQL读写分离详解，本文来说说抛开阿里云来实现读写分离的方法：

    方法一：php程序上自己做逻辑判断，写php代码的时候，自己在程序上做逻辑判读写匹配。select，insert、update、delete做正则匹配，根据结果选择写服务器（主服务器）。
        如果是select操作则选择读服务器（从服务器器） mysql_connect('读写的区分')
    方法二：MySQL中间件，基本的原理是让主数据库处理写操作（insert、update、delete），而从数据库处理查询操作（select）。
        而数据库的一致性则通过主从复制来实现。所以说主从复制是读写分离的基础。

###存储过程 [模块化编程，可以提高速度]

存储过程是SQL语句和控制语句的预编译集合，保存在数据库中，可有应用程序调用执行，而且允许用户声明变量、逻辑控制语句及其他强大的编程功能。

包含逻辑控制语句和数据操作语句，可以接收参数、输出参数、返回单个或多个结果值及返回值。


使用存储过程的优点：模块化程序设计，只需创建一次，以后即可调用该存储过程任意次；执行速度快，效率高；减少网络流量；具有良好的安全性。

###对mysql配置优化 [配置最大并发数, 调整缓存大小]

###定时的去清除不需要的数据,定时进行碎片整理
    1）查看表碎片的方法
    select ROW_FORMAT,TABLE_ROWS,DATA_LENGTH,INDEX_LENGTH,MAX_DATA_LENGTH,DATA_FREE,ENGINE from TABLES where TABLE_SCHEMA='test_db' and TABLE_NAME='table_name' limit 1;
    2）Innodb存储引擎清理碎片方法：
    ALTER TABLE tablename ENGINE=InnoDB
    3）Myisam存储引擎清理碎片方法：
    OPTIMIZE TABLE table_name
    注意：MySQL碎片整理尽量选择业务不繁忙时清理，一个月清理一次即可。


##参考：
- <a href="https://www.cnblogs.com/lideqiang0909/p/11162665.html" target="_blank">MySQL数据库优化的八种方式(经典必看)</a>
